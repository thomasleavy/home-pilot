import{a as i,b as c,c as o,d as a,n as v,q as l,ra as h}from"./chunk-NXQ7BON5.js";var u={production:!0,apiUrl:"http://localhost:3000"};var d=class r{http=l(h);baseUrl=u.apiUrl;ws=null;devicesSubject=new a([]);alertsSubject=new o;connectionStatusSubject=new a("disconnected");currentDevices=[];deviceStateOverlay=new Map;overlayStorageKey="mqtt-device-pilot.deviceStateOverlay";constructor(){this.loadOverlayFromStorage()}devices$=this.devicesSubject.asObservable();alerts$=this.alertsSubject.asObservable();connectionStatus$=this.connectionStatusSubject.asObservable();getDevices(){return this.http.get(`${this.baseUrl}/api/devices`)}setDeviceStateOverlay(e,t){let s=this.deviceStateOverlay.get(e)??{};this.deviceStateOverlay.set(e,i(i({},s),t)),this.saveOverlayToStorage(),this.devicesSubject.next(this.mergeOverlay(this.currentDevices))}getDeviceOverlay(e){return this.deviceStateOverlay.get(e)??{}}mergeOverlay(e){return e.map(t=>{let s=this.deviceStateOverlay.get(t.deviceId);return!s||Object.keys(s).length===0?t:c(i({},t),{state:i(i({},t.state),s)})})}setDevices(e){this.currentDevices=e,this.devicesSubject.next(this.mergeOverlay(e))}loadOverlayFromStorage(){try{let e=localStorage.getItem(this.overlayStorageKey);if(!e)return;let t=JSON.parse(e);this.deviceStateOverlay.clear(),Object.entries(t).forEach(([s,n])=>{n&&typeof n=="object"&&this.deviceStateOverlay.set(s,n)})}catch{}}saveOverlayToStorage(){try{let e={};this.deviceStateOverlay.forEach((t,s)=>{e[s]=t}),localStorage.setItem(this.overlayStorageKey,JSON.stringify(e))}catch{}}getAlerts(){return this.http.get(`${this.baseUrl}/api/alerts`)}sendCommand(e,t){return this.http.post(`${this.baseUrl}/api/devices/${e}/command`,t)}getHeatingHistory(){return this.http.get(`${this.baseUrl}/api/insights/heating-history?t=${Date.now()}`)}getHotWaterHistory(){return this.http.get(`${this.baseUrl}/api/insights/hot-water-history?t=${Date.now()}`)}connectWebSocket(){let e=this.baseUrl.replace(/^http/,"ws");this.connectionStatusSubject.next("connecting"),this.ws=new WebSocket(e),this.ws.onmessage=t=>{try{let s=JSON.parse(t.data);s.type==="devices"?this.setDevices(s.payload??[]):s.type==="alert"&&this.alertsSubject.next(s.payload),this.connectionStatusSubject.next("connected")}catch{}},this.ws.onopen=()=>{this.connectionStatusSubject.next("connected"),this.getDevices().subscribe(t=>this.setDevices(t)),this.getAlerts().subscribe()},this.ws.onclose=()=>{this.connectionStatusSubject.next("disconnected")},this.ws.onerror=()=>{this.connectionStatusSubject.next("poor")}}disconnectWebSocket(){this.ws&&(this.ws.close(),this.ws=null),this.connectionStatusSubject.next("disconnected")}static \u0275fac=function(t){return new(t||r)};static \u0275prov=v({token:r,factory:r.\u0275fac,providedIn:"root"})};export{u as a,d as b};
